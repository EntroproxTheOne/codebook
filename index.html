<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .canvas {
            width: 800px;
            height: 600px;
            background: white;
            border: 2px solid #333;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .draggable-item {
            width: 100px;
            height: 60px;
            background: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            border-radius: 8px;
            position: absolute;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: box-shadow 0.2s;
        }
        
        .draggable-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .draggable-item.dragging {
            opacity: 0.7;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .sidebar {
            width: 200px;
            height: 600px;
            background: #e0e0e0;
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 20px;
            float: left;
        }
        
        .sidebar-item {
            width: 80px;
            height: 50px;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            border-radius: 4px;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .sidebar-item:hover {
            background: #1976D2;
        }
        
        .debug-info {
            background: #333;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Drag and Drop Test Environment</h1>
        
        <div class="clearfix">
            <div class="sidebar">
                <h3>Drag from here:</h3>
                <div class="sidebar-item" data-draggable="true" data-type="module">Module 1</div>
                <div class="sidebar-item" data-draggable="true" data-type="module">Module 2</div>
                <div class="sidebar-item" data-draggable="true" data-type="module">Module 3</div>
            </div>
            
            <div class="canvas" id="canvas">
                <div class="draggable-item" style="left: 100px; top: 100px;" data-draggable="true" data-type="node">Node 1</div>
                <div class="draggable-item" style="left: 300px; top: 200px;" data-draggable="true" data-type="node">Node 2</div>
            </div>
        </div>
        
        <div class="debug-info" id="debug">
            <div>Debug Info:</div>
            <div id="debug-content">Ready...</div>
        </div>
    </div>

    <script>
        class DragDropTest {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.debugContent = document.getElementById('debug-content');
                this.draggedElement = null;
                this.dragOffset = { x: 0, y: 0 };
                this.startPos = { x: 0, y: 0 };
                this.isDragging = false;
                
                this.init();
            }
            
            init() {
                // Add event listeners to all draggable elements
                document.querySelectorAll('[data-draggable="true"]').forEach(element => {
                    element.addEventListener('mousedown', this.handleMouseDown.bind(this));
                });
                
                // Add global mouse events
                document.addEventListener('mousemove', this.handleMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                this.log('Drag and drop test initialized');
            }
            
            handleMouseDown(e) {
                e.preventDefault();
                e.stopPropagation();
                
                this.draggedElement = e.target;
                this.isDragging = true;
                this.startPos = { x: e.clientX, y: e.clientY };
                this.dragOffset = { x: 0, y: 0 };
                
                this.draggedElement.classList.add('dragging');
                this.draggedElement.style.cursor = 'grabbing';
                
                this.log(`Started dragging: ${this.draggedElement.textContent}`);
            }
            
            handleMouseMove(e) {
                if (!this.isDragging || !this.draggedElement) return;
                
                // Calculate movement
                const deltaX = e.clientX - this.startPos.x;
                const deltaY = e.clientY - this.startPos.y;
                
                // Update drag offset
                this.dragOffset.x += deltaX;
                this.dragOffset.y += deltaY;
                
                // Update start position for next calculation
                this.startPos = { x: e.clientX, y: e.clientY };
                
                // Apply transform
                this.draggedElement.style.transform = `translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;
                
                this.log(`Dragging: offset(${Math.round(this.dragOffset.x)}, ${Math.round(this.dragOffset.y)})`);
            }
            
            handleMouseUp(e) {
                if (!this.isDragging || !this.draggedElement) return;
                
                this.log(`Dropping at mouse position: (${e.clientX}, ${e.clientY})`);
                
                // Calculate final position
                let finalX, finalY;
                
                if (this.draggedElement.dataset.type === 'module') {
                    // For new modules, use mouse position relative to canvas
                    const canvasRect = this.canvas.getBoundingClientRect();
                    finalX = e.clientX - canvasRect.left;
                    finalY = e.clientY - canvasRect.top;
                    
                    this.log(`New module position: (${finalX}, ${finalY})`);
                    
                    // Create a new draggable item on the canvas
                    const newItem = this.draggedElement.cloneNode(true);
                    newItem.dataset.type = 'node'; // Change type to node
                    newItem.style.position = 'absolute';
                    newItem.style.left = finalX + 'px';
                    newItem.style.top = finalY + 'px';
                    newItem.style.transform = 'none';
                    newItem.classList.remove('dragging');
                    newItem.style.cursor = 'grab';
                    
                    // Add to canvas
                    this.canvas.appendChild(newItem);
                    
                    // Add event listener to the new item
                    newItem.addEventListener('mousedown', this.handleMouseDown.bind(this));
                    
                    this.log(`Created new node at: (${finalX}, ${finalY})`);
                    
                } else {
                    // For existing nodes, add offset to original position
                    const originalLeft = parseFloat(this.draggedElement.style.left) || 0;
                    const originalTop = parseFloat(this.draggedElement.style.top) || 0;
                    
                    finalX = originalLeft + this.dragOffset.x;
                    finalY = originalTop + this.dragOffset.y;
                    
                    this.log(`Node original: (${originalLeft}, ${originalTop}), offset: (${this.dragOffset.x}, ${this.dragOffset.y}), final: (${finalX}, ${finalY})`);
                    
                    // Update position
                    this.draggedElement.style.left = finalX + 'px';
                    this.draggedElement.style.top = finalY + 'px';
                    this.draggedElement.style.transform = 'none';
                }
                
                // Clean up
                this.draggedElement.classList.remove('dragging');
                this.draggedElement.style.cursor = 'grab';
                this.draggedElement.style.transform = 'none';
                
                this.log(`Final position set: (${finalX}, ${finalY})`);
                
                // Reset
                this.draggedElement = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                this.debugContent.scrollTop = this.debugContent.scrollHeight;
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DragDropTest();
        });
    </script>
</body>
</html>
